rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function getUserData(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }
    
    function getRole(uid) {
      let userData = getUserData(uid);
      return userData != null ? userData.role : 'user';
    }
    
    function isSuperAdmin(uid) {
      return getRole(uid) == 'superadmin';
    }
    
    function isAdmin(uid) {
      return getRole(uid) in ['admin', 'superadmin'];
    }
    
    function isVIP(uid) {
      return getRole(uid) in ['vip', 'ambassador', 'supreme', 'company_account', 'admin', 'superadmin'];
    }

    // Users Collection - Strict Access Control
    match /users/{userId} {
      // User can always read their own document
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // VIP and above can read all users (for genealogy tree building)
      // Simplified check to avoid circular dependencies
      allow read: if isAuthenticated() && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['vip', 'ambassador', 'supreme', 'company_account', 'admin', 'superadmin']
      );
      
      // SuperAdmin write access - handle missing documents gracefully
      // Allow users to create their own document, superadmin to manage all,
      // and allow users to update their own profile as long as they do not change their `role`.
      allow write: if isAuthenticated() && (
        // Bootstrap: User creating their own initial document
        (request.auth.uid == userId && resource == null)
        ||
        // SuperAdmin creating/updating any user
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin')
        ||
        // User creating/updating their own profile: allow if role is unchanged
        (
          request.auth.uid == userId && (
            // If the request omits `role` entirely OR the role remains equal to the existing value
            (!('role' in request.resource.data) || (resource.data.role == request.resource.data.role))
          )
        )
      );
      
      // Admin can create and manage non-superadmin users
      allow write: if isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin']
        && (resource == null || request.resource.data.role in ['user', 'vip', 'ambassador', 'supreme', 'cashier', 'admin']);
      
      // VIP and above can create new users when activating payment codes (resource == null means new document)
      allow create: if isAuthenticated() && 
        resource == null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['vip', 'ambassador', 'supreme', 'company_account', 'admin', 'superadmin'];
    }

    // Invitations Collection - VIP and above can send invitations
    match /invitations/{invitationId} {
      // Invited user can read their own invitation
      allow read: if isAuthenticated() && resource.data.invitedEmail == request.auth.token.email;
      
      // VIP and above can create invitations
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['vip', 'ambassador', 'supreme', 'company_account', 'admin', 'superadmin'];
      
      // Inviter can read and update their invitations
      allow read, update: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      
      // Admin can read all invitations
      allow read: if isAuthenticated() && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin']
      );
      
      // SuperAdmin can manage all invitations
      allow read, write: if isAuthenticated() && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin'
      );
    }

    // Code Requests Collection - VIP and above can create code requests for over-the-counter payments
    match /codeRequests/{codeRequestId} {
      // VIP and above can create code requests
      allow create: if isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['vip', 'ambassador', 'supreme', 'company_account', 'admin', 'superadmin']
      ) && request.resource.data.inviterId == request.auth.uid;
      
      // Requester can read and update their own code requests (to add receipt URL)
      allow read, update: if isAuthenticated() && resource.data.inviterId == request.auth.uid;
      
      // Admin and SuperAdmin can read and update all code requests
      allow read, write: if isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin']
      );
    }

    // Invite Slots Collection - Store pending invite slot codes
    match /inviteSlots/{slotId} {
      // VIP and above can create and read invite slots
      allow create, read: if isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['vip', 'ambassador', 'supreme', 'company_account', 'admin', 'superadmin']
      );
      
      // Admin and SuperAdmin can read and update all invite slots
      allow read, write: if isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin']
      );
    }
    
    match /genealogy/{document=**} {
      // SuperAdmin full access
      allow read, write: if isAuthenticated() && isSuperAdmin(request.auth.uid);
      
      // Admin can read all and manage
      allow read: if isAuthenticated() && isAdmin(request.auth.uid);
      allow write: if isAuthenticated() && isAdmin(request.auth.uid);
      
      // VIP and above can read genealogy data
      allow read: if isAuthenticated() && isVIP(request.auth.uid);
      
      // Users can only read their own genealogy branch
      allow read: if isAuthenticated() && (
        resource.data.uid == request.auth.uid ||
        resource.data.parentUid == request.auth.uid
      );
    }

    // User Profiles Collection - User can update their own profile
    match /userProfiles/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin(request.auth.uid)
      );
      
      allow write: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin(request.auth.uid)
      ) && !('role' in request.resource.data);
      
      allow update: if isAuthenticated() && isAdmin(request.auth.uid);
    }

    // Dashboard Data - Accessible to authenticated users
    match /dashboards/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin(request.auth.uid)
      );
      
      allow write: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin(request.auth.uid)
      );
      
      allow delete: if isAuthenticated() && isAdmin(request.auth.uid);
    }

    // Transactions Collection - Role-based access
    match /transactions/{document=**} {
      // SuperAdmin full access
      allow read, write: if isAuthenticated() && isSuperAdmin(request.auth.uid);
      
      // Admin and Cashier can create and read transactions
      allow create, read: if isAuthenticated() && getRole(request.auth.uid) in ['cashier', 'admin', 'superadmin'];
      
      // Admin can write to transactions
      allow write: if isAuthenticated() && isAdmin(request.auth.uid);
      
      // Users can only read their own transactions
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
    }

    // Activity Logs - Admin only
    match /activityLogs/{document=**} {
      allow read: if isAuthenticated() && isAdmin(request.auth.uid);
      allow write: if isAuthenticated(); // Any user can create logs for themselves
    }

    // Settings Collection - SuperAdmin only
    match /settings/{document=**} {
      allow read, write: if isAuthenticated() && isSuperAdmin(request.auth.uid);
      
      // Other users can read public settings
      allow read: if isAuthenticated() && resource.data.public == true;
    }

    // Frames Collection - SuperAdmin manages, all authenticated users read
    match /frames/{frameId} {
      // SuperAdmin full access (create, read, update, delete)
      allow read, write, delete: if isAuthenticated() && isSuperAdmin(request.auth.uid);
      
      // All authenticated users can read frames
      allow read: if isAuthenticated();
    }

    // Audit Logs Collection - SuperAdmin only read/write (created by Cloud Functions)
    match /audit_logs/{document=**} {
      // Only Cloud Functions (verified by `request.auth` being null from service context)
      // and SuperAdmins can read audit logs
      allow write: if request.auth == null; // Cloud Functions write without authentication context
      allow read: if isAuthenticated() && isSuperAdmin(request.auth.uid);
      allow delete: if false; // Never delete audit logs
    }

    // Default deny all other requests
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
