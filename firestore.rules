rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function getUserData(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }
    
    function getRole(uid) {
      let userData = getUserData(uid);
      return userData != null ? userData.role : 'user';
    }
    
    function isSuperAdmin(uid) {
      return getRole(uid) == 'superadmin';
    }
    
    function isAdmin(uid) {
      return getRole(uid) in ['admin', 'superadmin'];
    }
    
    function isVIP(uid) {
      return getRole(uid) in ['vip', 'ambassador', 'supreme', 'admin', 'superadmin'];
    }

    // Users Collection - Strict Access Control
    match /users/{userId} {
      // User can always read their own document
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // SuperAdmin write access - handle missing documents gracefully
      allow write: if isAuthenticated() && (
        // Bootstrap: User creating their own initial document
        (request.auth.uid == userId && resource == null)
        ||
        // SuperAdmin creating/updating any user
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin')
        ||
        // User creating/updating their own profile (except role field)
        (request.auth.uid == userId && !('role' in request.resource.data))
      );
      
      // Admin can read all users
      allow read: if isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin']
      );
      
      // Admin can create and manage non-superadmin users
      allow write: if isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin']
        && (resource == null || request.resource.data.role in ['user', 'vip', 'ambassador', 'supreme', 'cashier', 'admin']);
    }

    // Genealogy Collection - Role-based Access
    match /genealogy/{document=**} {
      // SuperAdmin full access
      allow read, write: if isAuthenticated() && isSuperAdmin(request.auth.uid);
      
      // Admin can read all and manage
      allow read: if isAuthenticated() && isAdmin(request.auth.uid);
      allow write: if isAuthenticated() && isAdmin(request.auth.uid);
      
      // VIP and above can read genealogy data
      allow read: if isAuthenticated() && isVIP(request.auth.uid);
      
      // Users can only read their own genealogy branch
      allow read: if isAuthenticated() && (
        resource.data.uid == request.auth.uid ||
        resource.data.parentUid == request.auth.uid
      );
    }

    // User Profiles Collection - User can update their own profile
    match /userProfiles/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin(request.auth.uid)
      );
      
      allow write: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin(request.auth.uid)
      ) && !('role' in request.resource.data);
      
      allow update: if isAuthenticated() && isAdmin(request.auth.uid);
    }

    // Dashboard Data - Accessible to authenticated users
    match /dashboards/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin(request.auth.uid)
      );
      
      allow write: if isAuthenticated() && (
        request.auth.uid == userId || isAdmin(request.auth.uid)
      );
      
      allow delete: if isAuthenticated() && isAdmin(request.auth.uid);
    }

    // Transactions Collection - Role-based access
    match /transactions/{document=**} {
      // SuperAdmin full access
      allow read, write: if isAuthenticated() && isSuperAdmin(request.auth.uid);
      
      // Cashier can create and read transactions
      allow create, read: if isAuthenticated() && getRole(request.auth.uid) in ['cashier', 'admin', 'superadmin'];
      allow write: if isAuthenticated() && isAdmin(request.auth.uid);
      
      // Users can only read their own transactions
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
    }

    // Activity Logs - Admin only
    match /activityLogs/{document=**} {
      allow read: if isAuthenticated() && isAdmin(request.auth.uid);
      allow write: if isAuthenticated(); // Any user can create logs for themselves
    }

    // Settings Collection - SuperAdmin only
    match /settings/{document=**} {
      allow read, write: if isAuthenticated() && isSuperAdmin(request.auth.uid);
      
      // Other users can read public settings
      allow read: if isAuthenticated() && resource.data.public == true;
    }

    // Audit Logs Collection - SuperAdmin only read/write (created by Cloud Functions)
    match /audit_logs/{document=**} {
      // Only Cloud Functions (verified by `request.auth` being null from service context)
      // and SuperAdmins can read audit logs
      allow write: if request.auth == null; // Cloud Functions write without authentication context
      allow read: if isAuthenticated() && isSuperAdmin(request.auth.uid);
      allow delete: if false; // Never delete audit logs
    }

    // Default deny all other requests
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
